{% extends "base.html" %}
{% load nautical_filters %}

{% block title %}{{ voyage.sujet_voyage }} - Livre de bord{% endblock %}

{% block content %}
<style>
  .voyage-header {
    background: linear-gradient(135deg, #007cba 0%, #005a87 100%);
    color: white;
    padding: 30px;
    border-radius: 8px;
    margin-bottom: 30px;
  }
  .voyage-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  .info-item {
    opacity: 0.9;
  }
  .info-label {
    font-size: 12px;
    text-transform: uppercase;
    margin-bottom: 5px;
    opacity: 0.8;
  }
  .info-value {
    font-size: 18px;
    font-weight: 600;
  }
  .timeline {
    position: relative;
    padding-left: 30px;
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #007cba;
  }
  .timeline-item {
    position: relative;
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -23px;
    top: 20px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #007cba;
    border: 3px solid white;
    box-shadow: 0 0 0 2px #007cba;
  }
  .timeline-time {
    color: #007cba;
    font-weight: 600;
    font-size: 14px;
  }
  .timeline-content {
    margin-top: 10px;
  }
  .nav-tabs {
    display: flex;
    border-bottom: 2px solid #f0f0f0;
    margin-bottom: 30px;
  }
  .nav-tab {
    padding: 12px 24px;
    border: none;
    background: none;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    color: #666;
    text-decoration: none;
    margin-right: 10px;
  }
  .nav-tab.active {
    color: #007cba;
    border-bottom-color: #007cba;
    font-weight: 600;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 30px;
  }
  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    text-decoration: none;
    display: inline-block;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-primary { background: #007cba; color: white; }
  .btn-success { background: #28a745; color: white; }
  .btn-warning { background: #ffc107; color: #212529; }
  .btn-danger { background: #dc3545; color: white; }
  .btn-secondary { background: #6c757d; color: white; }
  .entry-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    font-size: 14px;
  }
  .entry-field {
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
  }
  .entry-label {
    font-weight: 600;
    color: #666;
    font-size: 12px;
    margin-bottom: 3px;
  }
  .weather-card, .crew-card, .incident-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .incident-mineur { border-left: 4px solid #28a745; }
  .incident-moyen { border-left: 4px solid #ffc107; }
  .incident-grave { border-left: 4px solid #fd7e14; }
  .incident-critique { border-left: 4px solid #dc3545; }
</style>

<!-- Photo d'en-tête du voyage -->
{% if voyage.header_photo %}
<div style="position: relative; margin-bottom: 30px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
  <img src="{{ voyage.header_photo.image.url }}" alt="{{ voyage.header_photo.titre }}" 
       style="width: 100%; height: 300px; object-fit: cover;">
  <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.7) 100%);">
    <div class="voyage-header" style="background: none; color: white; position: absolute; bottom: 0; left: 0; right: 0;">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <h1 style="margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">🌴 {{ voyage.sujet_voyage }}</h1>
          <p style="margin: 10px 0 0 0; font-size: 18px; opacity: 0.9; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
            🚢 {{ voyage.bateau }} • {{ voyage.port_depart }} → {{ voyage.port_arrivee|default:"En cours" }}
          </p>
          {% if voyage.header_photo.titre %}
          <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.8; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
            📸 {{ voyage.header_photo.titre }}
          </p>
          {% endif %}
        </div>
        <span style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px;">
          {{ voyage.get_statut_display }}
        </span>
      </div>
      
      <div class="voyage-info">
        <div class="info-item">
          <div class="info-label">Skipper</div>
          <div class="info-value">{{ voyage.skipper }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Période</div>
          <div class="info-value">
            {{ voyage.date_debut|date_fr }}
            {% if voyage.date_fin %} - {{ voyage.date_fin|date_fr }}{% endif %}
          </div>
        </div>
        <div class="info-item">
          <div class="info-label">Entrées de log</div>
          <div class="info-value">{{ entries_total_count|default:0 }} entrées</div>
        </div>
        {% if voyage_duration %}
        <div class="info-item">
          <div class="info-label">Durée</div>
          <div class="info-value">{{ voyage_duration|duration_fr }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% else %}
<div class="voyage-header">
  <div style="display: flex; justify-content: space-between; align-items: start;">
    <div>
      <h1 style="margin: 0;">🌴 {{ voyage.sujet_voyage }}</h1>
      <p style="margin: 10px 0 0 0; font-size: 18px; opacity: 0.9;">
        🚢 {{ voyage.bateau }} • {{ voyage.port_depart }} → {{ voyage.port_arrivee|default:"En cours" }}
      </p>
    </div>
    <span style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px;">
      {{ voyage.get_statut_display }}
    </span>
  </div>
  
  <div class="voyage-info">
    <div class="info-item">
      <div class="info-label">Skipper</div>
      <div class="info-value">{{ voyage.skipper }}</div>
    </div>
    <div class="info-item">
      <div class="info-label">Période</div>
      <div class="info-value">
        {{ voyage.date_debut|date_fr }}
        {% if voyage.date_fin %} - {{ voyage.date_fin|date_fr }}{% endif %}
      </div>
    </div>
    <div class="info-item">
      <div class="info-label">Entrées de log</div>
      <div class="info-value">{{ entries_total_count|default:0 }} entrées</div>
    </div>
    {% if voyage_duration %}
    <div class="info-item">
      <div class="info-label">Durée</div>
      <div class="info-value">{{ voyage_duration|duration_fr }}</div>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<div class="action-buttons">
  <a href="{% url 'add_log_entry' voyage.pk %}" class="btn btn-primary">📝 Nouvelle entrée</a>
  {% if voyage.statut == 'en_cours' %}
  <a href="{% url 'voyage_log_live' voyage.pk %}" class="btn btn-success">🔴 Mode Live</a>
  {% endif %}
  <a href="{% url 'add_weather_condition' voyage.pk %}" class="btn btn-warning">🌤️ Ajouter météo</a>
  <a href="{% url 'add_crew_member' voyage.pk %}" class="btn btn-secondary">👥 Ajouter équipier</a>
  <a href="{% url 'add_incident' voyage.pk %}" class="btn btn-danger">⚠️ Signaler incident</a>
  <a href="{% url 'voyage_gallery' voyage.pk %}" class="btn btn-info">📸 Photos ({{ voyage.photos_count }})</a>
  <a href="{% url 'export_voyage_pdf' voyage.pk %}" class="btn btn-info" target="_blank">📄 Export PDF</a>
  <a href="{% url 'voyage_log_update' voyage.pk %}" class="btn btn-secondary">✏️ Modifier voyage</a>
  {% if voyage.statut == 'preparation' %}
  <a href="{% url 'voyage_log_delete' voyage.pk %}"
     class="btn btn-danger"
     onclick="return confirm('Confirmer la suppression du livre de bord ? Vous pourrez encore annuler à l\'étape suivante.');"
  >🗑️ Supprimer</a>
  {% endif %}
</div>

<!-- Navigation par onglets -->
<div class="nav-tabs">
  <button class="nav-tab active" onclick="showTab('timeline')">📋 Timeline</button>
  <button class="nav-tab" onclick="showTab('photos')">📸 Photos ({{ voyage.photos_count }})</button>
  <button class="nav-tab" onclick="showTab('weather')">🌤️ Météo</button>
  <button class="nav-tab" onclick="showTab('crew')">👥 Équipage</button>
  <button class="nav-tab" onclick="showTab('incidents')">⚠️ Incidents</button>
</div>

<!-- Onglet Timeline -->
<div id="timeline" class="tab-content active">
  <h3>📋 Entrées du livre de bord</h3>
  
  <div style="display:flex; align-items:center; gap:12px; margin:8px 0 16px 0; color:#555; font-size:14px;">
    <span>
      Affichées: <strong>{{ entries_shown_count }}</strong> / <strong>{{ entries_total_count }}</strong>
    </span>
    {% if entries_truncated and not show_all %}
      <a href="{% url 'voyage_log_detail' voyage.pk %}?all=1" class="btn btn-secondary" style="padding:6px 10px; font-size:12px;">Afficher tout</a>
    {% elif show_all %}
      <a href="{% url 'voyage_log_detail' voyage.pk %}" class="btn btn-secondary" style="padding:6px 10px; font-size:12px;">Afficher moins</a>
    {% endif %}
  </div>
  
  {% if entries %}
    <div class="timeline">
      {% for entry in entries %}
        <div class="timeline-item">
          <div class="timeline-time">
            {{ entry.date|date:"d/m/Y" }} - {{ entry.heure|time:"H:i" }}
          </div>
          
          <div class="timeline-content">
            <h4 style="margin: 0 0 10px 0;">{{ entry.evenements }}</h4>
            
            <div class="entry-grid">
              {% if entry.position %}
              <div class="entry-field">
                <div class="entry-label">Position</div>
                <div>{{ entry.position }}</div>
              </div>
              {% endif %}
              
              {% if entry.vent_force %}
              <div class="entry-field">
                <div class="entry-label">Vent</div>
                <div>{{ entry.vent_force }} {{ entry.vent_direction }}</div>
              </div>
              {% endif %}
              
              {% if entry.allure %}
              <div class="entry-field">
                <div class="entry-label">Allure</div>
                <div>{{ entry.allure }}</div>
              </div>
              {% endif %}
              
              {% if entry.cap_compas %}
              <div class="entry-field">
                <div class="entry-label">Cap</div>
                <div>{{ entry.cap_compas }}°</div>
              </div>
              {% endif %}
              
              {% if entry.log_nautique %}
              <div class="entry-field">
                <div class="entry-label">Log</div>
                <div>{{ entry.log_nautique }} NM</div>
              </div>
              {% endif %}
              
              {% if entry.sonde %}
              <div class="entry-field">
                <div class="entry-label">Sonde</div>
                <div>{{ entry.sonde }} m</div>
              </div>
              {% endif %}
            </div>
            
            <div style="margin-top: 10px; font-size: 12px;">
              <a href="{% url 'edit_log_entry' voyage.pk entry.pk %}" style="color: #007cba; text-decoration: none;">
                ✏️ Modifier
              </a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    {% if entries_truncated and not show_all %}
      <div style="margin-top:10px; color:#777; font-size:13px;">
        … {{ entries_remaining }} entrées supplémentaires masquées.
        <a href="{% url 'voyage_log_detail' voyage.pk %}?all=1" style="color:#007cba; text-decoration:none;">Afficher tout</a>
      </div>
    {% endif %}
  {% else %}
    <p style="text-align: center; color: #666; padding: 40px;">
      Aucune entrée dans le livre de bord.<br>
      <a href="{% url 'add_log_entry' voyage.pk %}">Ajouter la première entrée</a>
    </p>
  {% endif %}
</div>

<!-- Onglet Photos -->
<div id="photos" class="tab-content">
  <h3>📸 Photos du voyage</h3>
  
  <!-- Actions rapides -->
  <div style="margin-bottom: 20px; text-align: center;">
    {% if not voyage.header_photo %}
      <a href="{% url 'voyage_photo_upload' voyage.pk %}?type=header" class="btn btn-primary">
        📸 Ajouter photo d'en-tête
      </a>
    {% endif %}
    <a href="{% url 'voyage_photo_upload' voyage.pk %}?type=gallery" class="btn btn-secondary">
      🖼️ Ajouter photo à la galerie
    </a>
    <a href="{% url 'voyage_gallery' voyage.pk %}" class="btn btn-info">
      🔍 Voir toutes les photos
    </a>
  </div>

  <!-- Photo d'en-tête -->
  {% if voyage.header_photo %}
  <div style="margin-bottom: 30px;">
    <h4>📸 Photo d'en-tête</h4>
    <div class="photo-header-preview" style="position: relative; text-align: center;">
      <img src="{{ voyage.header_photo.image.url }}" alt="{{ voyage.header_photo.titre }}" 
           style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
      {% if voyage.header_photo.titre or voyage.header_photo.description %}
      <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: white; padding: 15px; border-radius: 0 0 8px 8px;">
        {% if voyage.header_photo.titre %}
          <h6 style="margin: 0 0 5px 0;">{{ voyage.header_photo.titre }}</h6>
        {% endif %}
        {% if voyage.header_photo.description %}
          <p style="margin: 0; font-size: 14px; opacity: 0.9;">{{ voyage.header_photo.description }}</p>
        {% endif %}
      </div>
      {% endif %}
      
      <!-- Actions -->
      <div style="position: absolute; top: 10px; right: 10px;">
        <a href="{% url 'voyage_photo_update' voyage.header_photo.pk %}" class="btn btn-light btn-sm" title="Modifier">
          ✏️
        </a>
        <a href="{% url 'voyage_photo_delete' voyage.header_photo.pk %}" class="btn btn-light btn-sm" title="Supprimer">
          🗑️
        </a>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Aperçu galerie -->
  <h4>🖼️ Galerie ({{ voyage.photos_count }} photo{% if voyage.photos_count > 1 %}s{% endif %})</h4>
  
  {% if voyage.gallery_photos %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
      {% for photo in voyage.gallery_photos|slice:":6" %}
        <div style="position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <img src="{{ photo.image.url }}" alt="{{ photo.titre }}" 
               style="width: 100%; height: 150px; object-fit: cover;">
          
          {% if photo.titre %}
          <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 8px; font-size: 12px;">
            {{ photo.titre }}
          </div>
          {% endif %}
          
          <!-- Actions overlay -->
          <div style="position: absolute; top: 5px; right: 5px; opacity: 0.8;">
            <a href="{% url 'voyage_photo_update' photo.pk %}" class="btn btn-light btn-sm" style="padding: 2px 6px; font-size: 10px;" title="Modifier">
              ✏️
            </a>
          </div>
        </div>
      {% endfor %}
    </div>
    
    {% if voyage.photos_count > 6 %}
    <p style="text-align: center; color: #666;">
      Et {{ voyage.photos_count|add:"-6" }} autre{% if voyage.photos_count|add:"-6" > 1 %}s{% endif %} photo{% if voyage.photos_count|add:"-6" > 1 %}s{% endif %}...
      <br>
      <a href="{% url 'voyage_gallery' voyage.pk %}">📸 Voir toutes les photos ({{ voyage.photos_count }})</a>
    </p>
    {% endif %}
  {% else %}
    <div style="text-align: center; color: #666; padding: 40px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
      <h5>🖼️ Aucune photo dans la galerie</h5>
      <p>Ajoutez des photos pour documenter ce voyage</p>
      <a href="{% url 'voyage_photo_upload' voyage.pk %}?type=gallery" class="btn btn-primary">
        📷 Ajouter la première photo
      </a>
    </div>
  {% endif %}
</div>

<!-- Onglet Météo -->
<div id="weather" class="tab-content">
  <h3>🌤️ Conditions météorologiques</h3>
  
  {% if weather_conditions %}
    {% for weather in weather_conditions %}
      <div class="weather-card">
        <div style="display: flex; justify-content: space-between;">
          <h4>{{ weather.datetime|date:"d/m/Y H:i" }}</h4>
          {% if weather.type_bulletin %}
            <span style="color: #666; font-size: 14px;">{{ weather.type_bulletin }}</span>
          {% endif %}
        </div>
        
        {% if weather.situation_generale %}
          <p><strong>Situation générale:</strong> {{ weather.situation_generale }}</p>
        {% endif %}
        
        {% if weather.prev_jour_vent %}
          <div style="margin: 10px 0;">
            <strong>Prévisions jour:</strong> 
            Vent {{ weather.prev_jour_vent }}, 
            Mer {{ weather.prev_jour_mer }}
          </div>
        {% endif %}
        
        {% if weather.marees %}
          <p><strong>Marées:</strong> {{ weather.marees }}</p>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p style="text-align: center; color: #666; padding: 40px;">
      Aucune condition météo enregistrée.<br>
      <a href="{% url 'add_weather_condition' voyage.pk %}">Ajouter des conditions météo</a>
    </p>
  {% endif %}
</div>

<!-- Onglet Équipage -->
<div id="crew" class="tab-content">
  <h3>👥 Équipage</h3>
  
  {% if crew_members %}
    {% for member in crew_members %}
      <div class="crew-card">
        <h4>{{ member.prenom }} {{ member.nom }}</h4>
        <p><strong>Rôle:</strong> {{ member.get_role_display }}</p>
        
        {% if member.contact_nom %}
          <p><strong>Contact d'urgence:</strong> {{ member.contact_nom }} ({{ member.contact_relation }})
          {% if member.contact_telephone %} - {{ member.contact_telephone }}{% endif %}</p>
        {% endif %}
        
        {% if member.date_embarquement %}
          <p><strong>Embarquement:</strong> {{ member.date_embarquement|date:"d/m/Y" }}
          {% if member.date_debarquement %} - <strong>Débarquement:</strong> {{ member.date_debarquement|date:"d/m/Y" }}{% endif %}</p>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p style="text-align: center; color: #666; padding: 40px;">
      Aucun membre d'équipage enregistré.<br>
      <a href="{% url 'add_crew_member' voyage.pk %}">Ajouter un membre d'équipage</a>
    </p>
  {% endif %}
</div>

<!-- Onglet Incidents -->
<div id="incidents" class="tab-content">
  <h3>⚠️ Incidents</h3>
  
  {% if incidents %}
    {% for incident in incidents %}
      <div class="incident-card incident-{{ incident.gravite }}">
        <div style="display: flex; justify-content: space-between;">
          <h4>{{ incident.get_type_incident_display }}</h4>
          <span style="color: #666; font-size: 14px;">
            {{ incident.datetime|date:"d/m/Y H:i" }} - 
            <strong>{{ incident.get_gravite_display }}</strong>
          </span>
        </div>
        
        <p>{{ incident.description }}</p>
        
        {% if incident.actions_prises %}
          <p><strong>Actions prises:</strong> {{ incident.actions_prises }}</p>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p style="text-align: center; color: #666; padding: 40px;">
      Aucun incident signalé. Tant mieux ! 🎉<br>
      <a href="{% url 'add_incident' voyage.pk %}">Signaler un incident</a>
    </p>
  {% endif %}
</div>

<script>
function showTab(tabName) {
  // Cacher tous les contenus
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // Déactiver tous les onglets
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Afficher le contenu sélectionné
  document.getElementById(tabName).classList.add('active');
  
  // Activer l'onglet sélectionné
  event.target.classList.add('active');
}
</script>

{% endblock %}