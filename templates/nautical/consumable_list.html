{% extends 'base.html' %}

{% block title %}Consommables â€” Logbook{% endblock %}

{% block head_extra %}
  <style>
    .thumb { max-width: 80px; max-height: 80px; border-radius: 6px; }
    .actions a { margin-right: .5rem; }
    .filters { display:flex; gap:8px; align-items:center; margin:.75rem 0; }
    .pagination a, .pagination span { margin-right:.4rem; }
    .pagination { margin-top: 1rem; }
  </style>
{% endblock %}

{% block content %}
  <div class="topbar">
    <div>
      <h2>ðŸ“¦ Consommables</h2>
      <p class="muted"><a href="/">Accueil</a> Â· <a href="/consommables/new/">+ Nouveau consommable</a></p>
    </div>
    <div>
      <a class="tag" href="/consommables/new/">+ Nouveau</a>
    </div>
  </div>

  <!-- React widget: valeur totale du stock + recherche client-side -->
  <div id="consumable-react-root" style="margin: .75rem 0;"></div>

  <!-- Filtres -->
  <form class="filters controls" method="get">
    <input type="search" name="q" placeholder="Rechercher (nom, rÃ©fÃ©rence, remarque)" value="{{ q }}">
    <select name="origin">
      <option value="">Toutes origines</option>
      {% for value, label in origin_choices %}
        <option value="{{ value }}" {% if value == origin_selected %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <button type="submit">Filtrer</button>
    <a href="/consommables/">RÃ©initialiser</a>

    <!-- ðŸ‘‰ Export CSV des rÃ©sultats filtrÃ©s -->
    <a style="margin-left:8px" href="?{% if querystring %}{{ querystring }}&{% endif %}export=csv">Exporter CSV</a>
    <a style="margin-left:8px" href="/consommables/export/pdf/{% if querystring %}?{{ querystring }}{% endif %}">Exporter PDF (A4)</a>
  </form>

  <p>Total : <strong>{{ page_obj.paginator.count }}</strong></p>

  <div style="overflow:auto">
    <table>
      <thead>
        <tr><th>Image</th><th>Nom</th><th>Origine</th><th>RÃ©fÃ©rence</th><th>QtÃ©</th><th>Prix (â‚¬)</th><th>Actions</th></tr>
      </thead>
      <tbody>
        {% for c in consumables %}
          <tr>
            <td>
              {% if c.image %}
                {% with name=c.image.name|lower %}
                  {% if name|slice:"-4:" == ".jpg" or name|slice:"-5:" == ".jpeg" or name|slice:"-4:" == ".png" %}
                    <img class="thumb" src="{{ c.image.url }}" alt="{{ c.name }}">
                  {% else %}
                    <a href="{{ c.image.url }}">TÃ©lÃ©charger</a>
                  {% endif %}
                {% endwith %}
              {% else %}â€”{% endif %}
            </td>

            <td>{{ c.name }}</td>
            <td>{{ c.get_origin_display }}</td>
            <td>{{ c.reference }}</td>
            <td>{{ c.quantity }}</td>
            <td>{% if c.price_eur %}{{ c.price_eur|floatformat:2 }} â‚¬{% else %}â€”{% endif %}</td>
            <td>
              <div class="table-actions">
                <a href="{% url 'consumable_edit' c.pk %}">Modifier</a>
                <a href="{% url 'consumable_delete' c.pk %}">Supprimer</a>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7">Aucun consommable.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    {% if is_paginated %}
      <div class="pagination">
        {% if page_obj.has_previous %}
          <a href="?{% if querystring %}{{ querystring }}&{% endif %}page=1">Â« PremiÃ¨re</a>
          <a href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">â€¹ PrÃ©cÃ©dent</a>
        {% endif %}

        <span>Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Suivant â€º</a>
          <a href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.paginator.num_pages }}">DerniÃ¨re Â»</a>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block scripts %}
  {% verbatim %}
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function ConsumableWidget() {
      const [items, setItems] = useState([]);
      const [filter, setFilter] = useState('');

      useEffect(() => {
        axios.get('/api/consommables/').then(res => setItems(res.data)).catch(console.error);
      }, []);

      const totalValue = items.reduce((acc, it) => acc + (Number(it.quantity || 0) * Number(it.price_eur || 0)), 0);
      const filtered = items.filter(it => {
        if (!filter) return true;
        const s = filter.toLowerCase();
        return (it.name || '').toLowerCase().includes(s) || (it.reference || '').toLowerCase().includes(s);
      });

      return (
        <div style={{border: '1px solid #e0e6ef', padding: '10px', borderRadius: 6}}>
          <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
            <div>
              <strong>Valeur totale du stock :</strong>
              <span style={{marginLeft:8}}>{totalValue.toFixed(2)} â‚¬</span>
            </div>
            <div>
              <input placeholder="Recherche client-side" value={filter} onChange={e => setFilter(e.target.value)} />
            </div>
          </div>
          <div style={{marginTop:8}}>
            <small>{filtered.length} Ã©lÃ©ments affichÃ©s (sur {items.length})</small>
            <ul>
              {filtered.slice(0,50).map(it => (
                <li key={it.id}>{it.name} â€” {it.quantity} Ã— {(it.price_eur || 0).toFixed(2)} â‚¬</li>
              ))}
            </ul>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('consumable-react-root')).render(<ConsumableWidget />);
  </script>
  {% endverbatim %}
{% endblock %}

