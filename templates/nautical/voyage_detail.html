{% extends 'base.html' %}

{% block title %}D√©tail voyage ‚Äî Logbook{% endblock %}

{% block head_extra %}
  <style>
    .media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .media-card{border:1px solid #eee;padding:8px;border-radius:8px}
    img{max-width:100%;height:auto;border-radius:6px}
    #detail-map{height:360px;border:1px solid #ddd;border-radius:8px;margin:10px 0}
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
{% endblock %}

{% block content %}
  <p><a href="/voyages/">‚Üê Retour</a></p>
  <h2>{{ object.departure_port }} ‚Üí {{ object.arrival_port }}</h2>
  <p>
    <a href="{% url 'voyage_edit' object.pk %}">‚úèÔ∏è Modifier</a>
    ¬∑
    <a href="{% url 'voyage_delete' object.pk %}">üóëÔ∏è Supprimer</a>
  </p>
  {% if object.cover_photo %}<p><img src="{{ object.cover_photo.url }}" alt="Cover"></p>{% endif %}
  <p><strong>D√©part :</strong> {{ object.start_datetime }} | <strong>Arriv√©e :</strong> {{ object.end_datetime }}</p>
  <p><strong>Positions :</strong> {{ object.start_position }} ‚Üí {{ object.end_position }}</p>

  <div id="detail-map"></div>

  <p>
    <strong>Distance :</strong> <span id="distance-value">{% if object.distance_nm %}{{ object.distance_nm }}{% else %}‚Äî{% endif %}</span> NM
    | <strong>Vitesse moy :</strong> <span id="speed-value">{% if object.avg_speed_kn %}{{ object.avg_speed_kn }}{% else %}‚Äî{% endif %}</span> kn
    | <strong>Dur√©e :</strong> <span id="duration-value">{% if object.duration_hours %}{{ object.duration_hours }} h{% else %}‚Äî{% endif %}</span>
    <button type="button" id="recalc-save-btn" style="margin-left:12px">üîÅ Recalculer et sauvegarder</button>
    <span id="recalc-status" style="margin-left:8px;font-size:.9em;opacity:.8"></span>
  </p>

  <p><strong>M√©t√©o :</strong> {{ object.weather }} | <strong>Vent :</strong> {{ object.wind }} | <strong>Mer :</strong> {{ object.sea_state }}</p>
  <p><strong>Moteur :</strong> {{ object.engine_hours }} h | <strong>Carburant :</strong> {{ object.fuel_liters }} L</p>
  <p><strong>√âquipage :</strong> {% for m in object.crew.all %}{{ m.full_name }}{% if not forloop.last %}, {% endif %}{% empty %}‚Äî{% endfor %}</p>

  <h3>Notes</h3><p style="white-space: pre-wrap">{{ object.notes }}</p>

  <h3>Maintenance li√©e</h3>
  <ul>{% for m in object.maintenance.all %}
    <li>{{ m.date }} ‚Äì {{ m.get_equipment_display }} : {{ m.description|truncatechars:80 }}</li>
  {% empty %}<li>‚Äî</li>{% endfor %}</ul>

  <h3>M√©dias</h3>
  <div class="media-grid">
    {% for media in object.media_assets.all %}
      <div class="media-card">
        {% if media.image %}<img src="{{ media.image.url }}" alt="{{ media.caption }}">{% endif %}
        <p>{{ media.caption }}</p>
        {% if media.file %}<a href="{{ media.file.url }}">T√©l√©charger</a>{% endif %}
      </div>
    {% empty %}<p>Aucun m√©dia.</p>{% endfor %}
  </div>

  <h4>Ajouter un m√©dia</h4>
  <form action="/voyages/{{ object.pk }}/upload/" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <label>Type</label>
    <select name="kind"><option value="photo">Photo</option><option value="video">Vid√©o (fichier)</option></select>
    <label>Image</label><input type="file" name="image" accept="image/*">
    <label>Fichier</label><input type="file" name="file">
    <label>L√©gende</label><input type="text" name="caption">
    <button type="submit">Uploader</button>
  </form>
{% endblock %}

{% block scripts %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  document.addEventListener('DOMContentLoaded', function(){
    // helper: try parsing decimal coords or DMS strings
    function tryDecimal(val){ if(!val) return null; var m = String(val).match(/([-\\d\\.]+)\\s*[,\\/]\\s*([-\\d\\.]+)/); if(m) return [parseFloat(m[1]), parseFloat(m[2])]; return null; }

    function parseDMS(coordStr){
      if(!coordStr) return null;
      var parts = coordStr.split('/');
      if(parts.length < 2) return tryDecimal(coordStr);
      function parsePart(p){
        var re = /([0-9]{1,3})[^0-9\\-]*([0-9]{1,3})?[^0-9\\-]*([0-9]{1,3}(?:\\.[0-9]+)?)?[^A-Za-z0-9\\-]*([NSEWnsew])?/;
        var m = p.match(re);
        if(!m) return null;
        var deg = parseFloat(m[1] || 0);
        var min = parseFloat(m[2] || 0);
        var sec = parseFloat(m[3] || 0);
        var dir = (m[4] || '').toUpperCase();
        var dec = deg + (min/60) + (sec/3600);
        if(dir === 'S' || dir === 'W') dec = -dec;
        return dec;
      }
      var lat = parsePart(parts[0]);
      var lng = parsePart(parts[1]);
      if(lat === null || lng === null) return null;
      return [lat, lng];
    }

    function parsePosition(sourcePos, decimalLat, decimalLng){
      if(decimalLat && decimalLng){ var la = parseFloat(decimalLat); var ln = parseFloat(decimalLng); if(!isNaN(la) && !isNaN(ln)) return [la, ln]; }
      var dec = tryDecimal(sourcePos);
      if(dec) return dec;
      return parseDMS(sourcePos);
    }

    var sPos = parsePosition('{{ object.start_position|escapejs }}', '{{ object.start_lat }}', '{{ object.start_lng }}');
    var ePos = parsePosition('{{ object.end_position|escapejs }}', '{{ object.end_lat }}', '{{ object.end_lng }}');

    var el = document.getElementById('detail-map');
    if(!el){ console.log('detail-map element not found'); return; }
    var map = L.map('detail-map').setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    console.log('Parsed positions:', {start: sPos, end: ePos});
    var markers = [];
    if(sPos){ L.marker(sPos).addTo(map).bindPopup('D√©part'); markers.push(sPos); }
    if(ePos){ L.marker(ePos).addTo(map).bindPopup('Arriv√©e'); markers.push(ePos); }

    if(sPos && ePos){
      var routeLine = L.polyline([sPos, ePos], {color:'blue', weight:3, opacity:0.7, dashArray:'6,6'}).addTo(map);
      var bounds = L.latLngBounds([sPos, ePos]);
      if(typeof bounds.pad === 'function'){
        map.fitBounds(bounds.pad(0.2), {padding:[20,20]});
      } else {
        map.fitBounds(bounds, {padding:[20,20]});
      }

      var serverDist = '{{ object.distance_nm }}';
      if(!serverDist || serverDist === 'None'){
        function toRad(v){ return v * Math.PI / 180; }
        var lat1 = sPos[0], lon1 = sPos[1], lat2 = ePos[0], lon2 = ePos[1];
        var dLat = toRad(lat2 - lat1);
        var dLon = toRad(lon2 - lon1);
        var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        var meters = 6371000.0 * c;
        var nm = meters / 1852.0;
        var nmRounded = Math.round(nm * 100)/100;
        var distEl = document.getElementById('distance-value');
        if(distEl) distEl.textContent = nmRounded.toFixed(2);
      }
    } else {
      if(markers.length) map.fitBounds(L.latLngBounds(markers), {padding:[20,20]});
    }

    var serverDur = '{{ object.duration_hours }}';
    if((!serverDur || serverDur === 'None') && '{{ object.start_datetime }}' && '{{ object.end_datetime }}'){
      try{
        var sd = new Date('{{ object.start_datetime }}');
        var ed = new Date('{{ object.end_datetime }}');
        if(!isNaN(sd.getTime()) && !isNaN(ed.getTime())){
          var hours = Math.round(((ed - sd)/(1000*60*60)) * 100)/100;
          var durEl = document.getElementById('duration-value');
          if(durEl) durEl.textContent = hours.toFixed(2) + ' h';
        }
      }catch(err){ console.log('duration calc error', err); }
    }

    var recalcBtn = document.getElementById('recalc-save-btn');
    var statusEl = document.getElementById('recalc-status');
    function getCookie(name){ var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return v ? v.pop() : ''; }

    if(recalcBtn){
      recalcBtn.addEventListener('click', function(){
        statusEl.textContent = 'Calcul en cours...';
        var s = sPos, e = ePos;
        if(!s || !e){ statusEl.textContent = 'Positions manquantes.'; return; }
        function toRad(v){ return v * Math.PI / 180; }
        var dLat = toRad(e[0] - s[0]);
        var dLon = toRad(e[1] - s[1]);
        var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(s[0]))*Math.cos(toRad(e[0]))*Math.sin(dLon/2)*Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        var meters = 6371000.0 * c;
        var nm = meters / 1852.0;
        var nmRounded = Math.round(nm * 100)/100;
        var sd = new Date('{{ object.start_datetime }}');
        var ed = new Date('{{ object.end_datetime }}');
        var hours = null;
        if(!isNaN(sd.getTime()) && !isNaN(ed.getTime())) hours = Math.round(((ed - sd)/(1000*60*60)) * 100)/100;

        var payload = { distance_nm: nmRounded };
        if(hours !== null) payload.duration_hours = hours;

        var url = '/api/voyages/{{ object.pk }}/';
        fetch(url, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify(payload)
        }).then(function(resp){ if(!resp.ok) throw new Error('HTTP ' + resp.status); return resp.json(); }).then(function(data){ var distEl = document.getElementById('distance-value'); if(distEl) distEl.textContent = (data.distance_nm !== null ? parseFloat(data.distance_nm).toFixed(2) : '‚Äî'); var durEl = document.getElementById('duration-value'); if(durEl) durEl.textContent = (data.duration_hours !== null ? parseFloat(data.duration_hours).toFixed(2) + ' h' : '‚Äî'); statusEl.textContent = 'Sauvegard√©.'; }).catch(function(err){ console.log('save error', err); statusEl.textContent = 'Erreur sauvegarde'; });
      });
    }
  });
  </script>
{% endblock %}
  <label>L√©gende</label><input type="text" name="caption">
  <button type="submit">Uploader</button>
</form>
</body></html>
